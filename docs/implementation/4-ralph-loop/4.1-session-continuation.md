# 4.1 Session Continuation Mode

This is the core Phase 1 implementation â€” enabling Flight Rules sessions to run autonomously in sequence, using session logs as the memory bridge between fresh AI instances.

## Goals

- Enable autonomous multi-session execution
- Use session logs as the queue and memory mechanism
- Support verification commands for automated pass/fail
- Maintain human oversight with clear checkpoints

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SESSION CONTINUATION LOOP                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. Read previous session log's "Next Steps" section            â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  2. Pick first actionable item as session goal                  â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  3. Start new session (fresh context)                           â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  4. Implement goal                                              â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  5. Run verification (if defined)                               â”‚
â”‚                          â”‚                                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â–¼                       â–¼                           â”‚
â”‚         [PASS]                   [FAIL]                          â”‚
â”‚              â”‚                       â”‚                           â”‚
â”‚              â–¼                       â–¼                           â”‚
â”‚  6a. End session normally     6b. Document failure,             â”‚
â”‚      Document next steps          add "fix" to next steps       â”‚
â”‚              â”‚                       â”‚                           â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                          â–¼                                       â”‚
â”‚  7. Commit changes, update progress.md                          â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  8. Spawn fresh agent instance OR signal orchestrator           â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  9. Loop until "Next Steps" is empty or limit reached           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Dependencies

- Existing `dev-session.start` and `dev-session.end` commands
- Session log template (`.flight-rules/doc-templates/session-log.md`)
- Progress tracking (`docs/progress.md`)

---

## 4.1.1. Extended Session Log Format

**Goal**: Define verification tags for the "Next Steps" section that enable automated queue processing.

**Approach**:

The existing "Next Steps" section becomes a structured queue:

```markdown
## Next Steps

Priority items for the next session:

1. **[VERIFY: npm test]** Implement user authentication endpoint
2. **[VERIFY: npm run build]** Add error handling to API routes
3. **[NO-VERIFY]** Update documentation for new endpoints
4. **[BLOCKED: needs design review]** Implement dashboard UI
```

**Tag Types**:
| Tag | Meaning | Behavior |
|-----|---------|----------|
| `[VERIFY: <command>]` | Has automated verification | Run command after implementation; pass/fail based on exit code |
| `[NO-VERIFY]` | No automated check possible | Mark complete after implementation, trust AI self-assessment |
| `[BLOCKED: <reason>]` | Cannot proceed automatically | Skip item, keep in queue for human intervention |
| `[PRIORITY: <1-3>]` | Optional priority hint | Process in priority order (default: 1) |

**Extended Format** (optional additional metadata):
```markdown
1. **[VERIFY: npm test -- --grep "auth"]** Implement user authentication endpoint
   - Timeout: 120s
   - Retry: 2
   - On-fail: create-fix-task
```

**Deliverables**:
- Updated session-log.md template with verification tag documentation
- Parsing logic specification for tags

**Acceptance Criteria**:
- Tags are human-readable and don't break existing workflows
- Existing session logs remain valid (graceful degradation)
- All tag types have clear semantics

**Status**: ğŸ”µ Planned

---

## 4.1.2. continuous-session.start Command

**Goal**: Create a command that initiates an autonomous session continuation loop.

**Approach**:

Create `.flight-rules/commands/continuous-session.start.md`:

```
Usage: /continuous-session.start [options]

Options:
  --max-sessions <n>      Maximum sessions to run (default: 5)
  --require-verify        Only process items with [VERIFY:] tags
  --pause-on-fail         Pause loop for human review on failure
  --from-session <file>   Start from specific session log file
  --dry-run               Show what would be executed without running
```

**Command Flow**:

1. **Locate the queue**
   - Find most recent session log in `docs/session_logs/`
   - Or use `--from-session` to specify starting point
   - Parse "Next Steps" section for actionable items

2. **Select first actionable item**
   - Skip `[BLOCKED:]` items
   - If `--require-verify`, skip `[NO-VERIFY]` items
   - Pick first remaining item

3. **Initialize loop state**
   - Create/update `docs/.continuous-session-state.json`:
     ```json
     {
       "status": "running",
       "startedAt": "2025-01-17T14:00:00Z",
       "maxSessions": 5,
       "currentSession": 1,
       "completedItems": [],
       "failedItems": [],
       "sourceSession": "docs/session_logs/20250117_1400_session.md"
     }
     ```

4. **Execute session**
   - Call existing `dev-session.start` logic with the selected goal
   - Implement the goal
   - Run verification if specified
   - Call existing `dev-session.end` logic

5. **Handle result**
   - **Pass**: Mark item complete, commit, update progress
   - **Fail**: Log failure, optionally create fix task, optionally pause

6. **Continue or terminate**
   - If more items and under limit: spawn next session (see 4.4 Orchestration)
   - If queue empty or limit reached: generate summary and exit

**Deliverables**:
- Command file: `.flight-rules/commands/continuous-session.start.md`
- State file schema: `docs/.continuous-session-state.json`

**Acceptance Criteria**:
- Command correctly parses Next Steps queue
- State file tracks progress across sessions
- Respects max-sessions limit
- Handles verification pass/fail appropriately
- Produces clear output showing what's being executed

**Status**: ğŸ”µ Planned

---

## 4.1.3. continuous-session.status Command

**Goal**: Create a command to display the current state of an ongoing continuous session loop.

**Approach**:

Create `.flight-rules/commands/continuous-session.status.md`:

**Output Format**:
```
## Continuous Session Status

Mode: RUNNING | PAUSED | COMPLETE | FAILED
Current session: 3 of 5 max
Session log: docs/session_logs/20250117_1600_session.md

Completed this run:
  âœ… Session 1: Implement user authentication endpoint (3m 22s)
  âœ… Session 2: Add error handling to API routes (2m 45s)
  ğŸŸ¡ Session 3: Fix test failures from session 2 (in progress)

Failures: 1
  âŒ Session 2 verification failed, created fix task

Remaining in queue:
  - Update documentation for new endpoints [NO-VERIFY]
  - Implement dashboard UI [BLOCKED: needs design review]

Elapsed: 8m 22s
```

**Command Flow**:

1. Read `docs/.continuous-session-state.json`
2. Find current session log
3. Display formatted status

**Deliverables**:
- Command file: `.flight-rules/commands/continuous-session.status.md`

**Acceptance Criteria**:
- Shows accurate current state
- Displays completed items with timing
- Shows failures with context
- Lists remaining queue items
- Works when no loop is running (shows "No active continuous session")

**Status**: ğŸ”µ Planned

---

## 4.1.4. continuous-session.stop Command

**Goal**: Allow graceful termination of a running continuous session loop.

**Approach**:

Create `.flight-rules/commands/continuous-session.stop.md`:

**Behavior**:
1. Set state status to "stopping"
2. Current session completes normally
3. Loop terminates after current session
4. Generate final summary

**Output**:
```
Continuous session stop requested.
Current session (3 of 5) will complete, then loop will terminate.
Run /continuous-session.status to monitor.
```

**Deliverables**:
- Command file: `.flight-rules/commands/continuous-session.stop.md`

**Acceptance Criteria**:
- Gracefully stops the loop after current session
- Does not interrupt work in progress
- Clears state file appropriately

**Status**: ğŸ”µ Planned

---

## 4.1.5. Session Log Queue Parser

**Goal**: Implement robust parsing of the "Next Steps" section with verification tags.

**Approach**:

This is the core parsing logic used by `continuous-session.start`:

**Parser Specification**:

```typescript
interface QueueItem {
  title: string;           // The task description
  verification?: {
    type: 'command' | 'none' | 'blocked';
    command?: string;      // For [VERIFY: <cmd>]
    reason?: string;       // For [BLOCKED: <reason>]
  };
  priority?: number;       // From [PRIORITY: N], default 1
  metadata?: {
    timeout?: number;      // In seconds
    retries?: number;
    onFail?: 'create-fix-task' | 'pause' | 'skip';
  };
  raw: string;             // Original markdown line
}

function parseNextSteps(sessionLogContent: string): QueueItem[];
```

**Parsing Rules**:

1. Find the "## Next Steps" section (case-insensitive)
2. Extract numbered/bulleted list items
3. For each item:
   - Extract `[TAG: value]` patterns (multiple allowed)
   - Parse optional metadata block (indented lines starting with `-`)
   - Build QueueItem object
4. Sort by priority (if specified)
5. Return ordered list

**Edge Cases**:
- No Next Steps section â†’ empty queue
- Items without tags â†’ treated as `[NO-VERIFY]`
- Malformed tags â†’ log warning, treat as no-verify
- Empty section â†’ empty queue

**Deliverables**:
- Parser specification (can be implemented as prompt logic or helper utility)
- Test cases for various input formats

**Acceptance Criteria**:
- Correctly parses all tag types
- Handles edge cases gracefully
- Preserves original text for display
- Extracts metadata when present

**Status**: ğŸ”µ Planned

---

## 4.1.6. Verification Execution

**Goal**: Implement the logic to run verification commands and handle results.

**Approach**:

**Execution Flow**:
```
1. Parse verification command from queue item
2. Execute command via shell
   - Capture stdout, stderr
   - Apply timeout (default: 120s, from metadata if specified)
   - Track execution time
3. Evaluate result
   - Exit code 0 â†’ PASS
   - Exit code non-0 â†’ FAIL
   - Timeout â†’ FAIL with timeout flag
4. Return verification result
```

**Result Structure**:
```typescript
interface VerificationResult {
  passed: boolean;
  exitCode: number;
  stdout: string;
  stderr: string;
  executionTime: number;  // ms
  timedOut: boolean;
  command: string;
}
```

**Failure Handling Options** (from metadata or command options):
1. `create-fix-task`: Add "Fix: [original task]" to Next Steps
2. `pause`: Stop loop for human review
3. `skip`: Log failure and continue to next item
4. `retry`: Re-attempt N times (from metadata)

**Deliverables**:
- Verification execution specification
- Failure handling logic

**Acceptance Criteria**:
- Commands execute in project directory
- Stdout/stderr captured for debugging
- Timeout prevents runaway processes
- Clear pass/fail determination
- Flexible failure handling

**Status**: ğŸ”µ Planned

---

## 4.1.7. Progress and Commit Integration

**Goal**: Ensure each completed session item properly updates progress.md and creates a git commit.

**Approach**:

After each successful session:

1. **Update progress.md**:
   ```markdown
   ### 2025-01-17 16:00 (Continuous Session 3/5)

   - Implemented: Add error handling to API routes
   - Verification: âœ… Passed (npm run build)
   - See: [session_logs/20250117_1600_session.md](session_logs/20250117_1600_session.md)
   ```

2. **Create git commit**:
   ```
   feat: add error handling to API routes

   Continuous session 3/5
   Verification: npm run build âœ…
   Session log: docs/session_logs/20250117_1600_session.md
   ```

3. **Update continuous session state**:
   - Add to `completedItems` array
   - Increment `currentSession`

**Deliverables**:
- Progress.md update format for continuous sessions
- Commit message template for continuous sessions

**Acceptance Criteria**:
- Progress entries clearly indicate continuous session context
- Commits are atomic (one per completed item)
- State file accurately reflects progress

**Status**: ğŸ”µ Planned

---

## 4.1.8. Session Continuation Summary

**Goal**: Generate a comprehensive summary when the continuous session loop completes.

**Approach**:

When loop terminates (queue empty, limit reached, or stopped):

**Summary Output**:
```markdown
# Continuous Session Summary

**Run**: 2025-01-17 14:00 - 16:45 (2h 45m)
**Sessions**: 5 of 5 max

## Completed (4)

| # | Task | Verification | Time |
|---|------|--------------|------|
| 1 | Implement user auth endpoint | âœ… npm test | 12m |
| 2 | Add error handling | âœ… npm run build | 8m |
| 3 | Fix test failures | âœ… npm test | 4m |
| 4 | Update documentation | â­ï¸ No verify | 6m |

## Failed (1)

| # | Task | Verification | Error |
|---|------|--------------|-------|
| 2 | Add error handling (attempt 1) | âŒ npm run build | Exit 1: Type error... |

## Skipped (1)

- Implement dashboard UI [BLOCKED: needs design review]

## Statistics

- Total time: 2h 45m
- Success rate: 80% (4/5)
- Commits created: 4

## Next Steps

Remaining items have been preserved in the latest session log:
`docs/session_logs/20250117_1645_session.md`
```

**Deliverables**:
- Summary template
- Summary generation logic

**Acceptance Criteria**:
- Summary captures all sessions in the run
- Failed items include error context
- Statistics are accurate
- Remaining items are clear

**Status**: ğŸ”µ Planned
