# 4.3 Story Tracking

This is the Phase 3 implementation â€” adding Ralph-style `passes: true/false` tracking directly to the PRD's user stories, making the PRD the high-level source of truth for project completion.

## Goals

- Create `prd-status.json` for machine-readable story tracking
- Add acceptance criteria to PRD user stories
- Map stories to implementation tasks
- Enable story-level verification loop
- Provide clear project completion metrics

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PRD STORY LOOP                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. Load prd-status.json                                        â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  2. Find first story with passes: false                         â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  3. Check if story maps to existing Tasks                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â–¼                       â–¼                           â”‚
â”‚      [Tasks exist]           [No tasks]                          â”‚
â”‚              â”‚                       â”‚                           â”‚
â”‚              â–¼                       â–¼                           â”‚
â”‚  4a. Execute via Task Loop   4b. Create tasks first,            â”‚
â”‚                                  then execute                    â”‚
â”‚              â”‚                       â”‚                           â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                          â–¼                                       â”‚
â”‚  5. Run story acceptance criteria                               â”‚
â”‚                          â”‚                                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â–¼                       â–¼                           â”‚
â”‚         [PASS]                   [FAIL]                          â”‚
â”‚              â”‚                       â”‚                           â”‚
â”‚              â–¼                       â–¼                           â”‚
â”‚  6a. Mark passes: true       6b. Log failure,                   â”‚
â”‚      Commit + update progress     create fix tasks              â”‚
â”‚              â”‚                       â”‚                           â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                          â–¼                                       â”‚
â”‚  7. Loop until all stories pass or limit reached                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Dependencies

- Phase 1: Session Continuation Mode (4.1)
- Phase 2: Task Verification Layer (4.2)
- Existing PRD at `docs/prd.md`
- Implementation spec system

---

## 4.3.1. PRD Status File Schema

**Goal**: Define the `docs/prd-status.json` schema for tracking story completion.

**Approach**:

**File Location**: `docs/prd-status.json`

**Schema**:
```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "properties": {
    "version": {
      "type": "integer",
      "description": "Schema version for future migrations"
    },
    "lastUpdated": {
      "type": "string",
      "format": "date-time"
    },
    "prdFile": {
      "type": "string",
      "description": "Path to the PRD this tracks",
      "default": "docs/prd.md"
    },
    "stories": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/story"
      }
    },
    "statistics": {
      "type": "object",
      "properties": {
        "total": { "type": "integer" },
        "passed": { "type": "integer" },
        "failed": { "type": "integer" },
        "pending": { "type": "integer" }
      }
    }
  },
  "$defs": {
    "story": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Story identifier (e.g., 'US-1', 'story-1')"
        },
        "title": {
          "type": "string"
        },
        "passes": {
          "type": "boolean",
          "description": "Whether the story passes all acceptance criteria"
        },
        "lastVerified": {
          "type": "string",
          "format": "date-time",
          "description": "When this story was last verified"
        },
        "verification": {
          "$ref": "#/$defs/verification"
        },
        "implementedBy": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Task IDs that implement this story (e.g., ['1.4.1', '1.4.2'])"
        },
        "history": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "date": { "type": "string", "format": "date-time" },
              "result": { "type": "string", "enum": ["pass", "fail"] },
              "notes": { "type": "string" }
            }
          }
        }
      },
      "required": ["id", "title", "passes"]
    },
    "verification": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["command", "manual", "tasks"]
        },
        "command": {
          "type": "string",
          "description": "For type=command: shell command to run"
        },
        "expected": {
          "type": "string",
          "default": "exit 0"
        },
        "criteria": {
          "type": "array",
          "items": { "type": "string" },
          "description": "For type=manual: checklist items"
        }
      }
    }
  }
}
```

**Example File**:
```json
{
  "version": 1,
  "lastUpdated": "2025-01-17T14:30:00Z",
  "prdFile": "docs/prd.md",
  "stories": [
    {
      "id": "US-1",
      "title": "Consistent workflow across projects",
      "passes": true,
      "lastVerified": "2025-01-15T10:00:00Z",
      "verification": {
        "type": "command",
        "command": "flight-rules init --non-interactive && test -f .flight-rules/AGENTS.md"
      },
      "implementedBy": ["2.1.1", "2.1.2", "2.1.3"]
    },
    {
      "id": "US-2",
      "title": "Agent/tool portability",
      "passes": false,
      "verification": {
        "type": "tasks",
        "criteria": ["All linked tasks complete and verified"]
      },
      "implementedBy": ["2.3.1", "2.3.2"]
    }
  ],
  "statistics": {
    "total": 12,
    "passed": 5,
    "failed": 1,
    "pending": 6
  }
}
```

**Deliverables**:
- JSON Schema definition
- Example prd-status.json
- Documentation for manual editing

**Acceptance Criteria**:
- Schema is comprehensive and extensible
- Supports all verification types
- Tracks history for debugging
- Statistics are always current

**Status**: ğŸ”µ Planned

---

## 4.3.2. PRD Format Extension

**Goal**: Extend the PRD format to include acceptance criteria and verification info.

**Approach**:

**Current PRD User Story Format**:
```markdown
## User Stories

1. **As a developer using AI coding tools**, I want a consistent project
   structure so that I don't have to re-explain my workflow every time.
```

**Extended Format**:
```markdown
## User Stories

### US-1: Consistent workflow across projects

**As a** developer using AI coding tools
**I want** a consistent project structure
**So that** I don't have to re-explain my workflow every time

**Acceptance Criteria:**
- [ ] `flight-rules init` completes in under 5 seconds
- [ ] Creates `.flight-rules/` with AGENTS.md
- [ ] Creates `docs/` with prd.md, progress.md
- [ ] Works in empty directory and existing project

**Verification:** `npm test -- --grep "init command"`
**Implemented by:** 2.1.1, 2.1.2, 2.1.3
```

**New Elements**:

| Element | Description |
|---------|-------------|
| `### US-N: Title` | Unique story identifier and title |
| `**Acceptance Criteria:**` | Checklist of success conditions |
| `**Verification:**` | Command or "manual" |
| `**Implemented by:**` | Comma-separated task IDs |

**Backward Compatibility**:
- Existing PRDs without this format remain valid
- `prd-status.json` can be generated from simple PRDs with manual mapping
- Migration path: run `/prd.enhance` to add structure

**Deliverables**:
- Extended PRD format specification
- Updated PRD template
- Migration command specification

**Acceptance Criteria**:
- Format is human-readable and maintainable
- Parseable for automated processing
- Existing PRDs remain valid

**Status**: ğŸ”µ Planned

---

## 4.3.3. Story-Task Mapping System

**Goal**: Maintain bidirectional links between PRD stories and implementation tasks.

**Approach**:

**Two-way Linking**:

1. **PRD â†’ Tasks** (in prd-status.json):
   ```json
   {
     "id": "US-3",
     "implementedBy": ["3.1.1", "3.1.2", "3.2.1"]
   }
   ```

2. **Tasks â†’ Story** (in task specs):
   ```markdown
   ### 3.1.1. PRD Create Command

   **Goals:** ...
   **Implements:** US-3
   **Status:** âœ… Complete
   ```

**Mapping Operations**:

```typescript
interface StoryTaskMapping {
  // Get all tasks that implement a story
  getTasksForStory(storyId: string): Task[];

  // Get which story a task implements
  getStoryForTask(taskId: string): Story | null;

  // Check if all tasks for a story are complete
  areAllTasksComplete(storyId: string): boolean;

  // Check if all tasks for a story are verified
  areAllTasksVerified(storyId: string): boolean;

  // Find orphan tasks (not linked to any story)
  findOrphanTasks(): Task[];

  // Find stories without implementation tasks
  findUnimplementedStories(): Story[];
}
```

**Validation**:
- Warn if tasks reference non-existent stories
- Warn if stories reference non-existent tasks
- Report orphan tasks and unimplemented stories

**Deliverables**:
- Mapping system specification
- Validation rules
- Orphan detection logic

**Acceptance Criteria**:
- Bidirectional links are maintainable
- Validation catches inconsistencies
- Easy to query relationships

**Status**: ğŸ”µ Planned

---

## 4.3.4. story-loop.start Command

**Goal**: Create a command that iterates through PRD stories with verification.

**Approach**:

Create `.flight-rules/commands/story-loop.start.md`:

```
Usage: /story-loop.start [options]

Options:
  --story <id>            Start from specific story (e.g., "US-3")
  --max-stories <n>       Maximum stories to attempt (default: 3)
  --skip-manual           Skip stories with manual verification
  --create-tasks          Auto-create implementation tasks if missing
  --task-loop             Use task-loop for implementation (default: session)
```

**Command Flow**:

1. **Load PRD status**
   - Read `docs/prd-status.json`
   - If missing, generate from PRD with all stories as `passes: false`

2. **Select story**
   - Find first story with `passes: false`
   - Skip `type: manual` if `--skip-manual`
   - Use `--story` to start from specific point

3. **Check implementation tasks**
   - Look up `implementedBy` array
   - If empty and `--create-tasks`: prompt to create tasks
   - If empty and no flag: error with guidance

4. **Execute implementation**
   - **If `--task-loop`**: Run task-loop for linked tasks
   - **Otherwise**: Start session with story as goal

5. **Verify story**
   - **Command verification**: Run specified command
   - **Task verification**: Check all linked tasks are complete + verified
   - **Manual verification**: Prompt for human sign-off

6. **Update status**
   - On pass: Set `passes: true`, update `lastVerified`
   - On fail: Log failure, add to history

7. **Continue or terminate**
   - More stories and under limit â†’ next story
   - All passed or limit reached â†’ generate summary

**Deliverables**:
- Command file: `.flight-rules/commands/story-loop.start.md`

**Acceptance Criteria**:
- Correctly processes stories in order
- Handles all verification types
- Updates prd-status.json accurately
- Integrates with task-loop when specified

**Status**: ğŸ”µ Planned

---

## 4.3.5. story-loop.status Command

**Goal**: Display the current state of PRD story completion.

**Approach**:

Create `.flight-rules/commands/story-loop.status.md`:

**Output Format**:
```
## Story Loop Status

Currently: RUNNING
Active story: US-3 (Structured path from requirements to implementation)

PRD Progress:
  âœ… US-1: Consistent workflow across projects
  âœ… US-2: Agent/tool portability
  ğŸŸ¡ US-3: Structured path from requirements to implementation
      â””â”€ Tasks: 3.1.1 âœ…, 3.1.2 ğŸŸ¡, 3.2.1 ğŸ”µ
  ğŸ”µ US-4: Preserve context across time and agents
  ğŸ”µ US-5: Documentation reconciliation

Stories passed: 2/5 (40%)
Tasks complete: 8/15 (53%)
```

**Deliverables**:
- Command file: `.flight-rules/commands/story-loop.status.md`

**Acceptance Criteria**:
- Shows story completion status
- Shows linked task status
- Provides completion percentages
- Identifies current work

**Status**: ğŸ”µ Planned

---

## 4.3.6. PRD Status Generator

**Goal**: Generate initial prd-status.json from an existing PRD.

**Approach**:

Create `/prd.status-init` command:

**Flow**:
1. Parse `docs/prd.md` for user stories
2. Extract story IDs, titles, acceptance criteria
3. Look for existing `**Verification:**` and `**Implemented by:**` annotations
4. Match stories to tasks by keyword/title similarity (heuristic)
5. Generate `docs/prd-status.json` with all stories as `passes: false`
6. Report what was found and ask for confirmation

**Heuristic Matching**:
- Match story titles to task group names
- Match acceptance criteria keywords to task goals
- Present matches for human review

**Output**:
```
Found 5 user stories in docs/prd.md

Proposed story-task mapping:
  US-1 "Consistent workflow" â†’ Tasks: 2.1.1, 2.1.2 (high confidence)
  US-2 "Agent portability" â†’ Tasks: 2.3.1, 2.3.2 (medium confidence)
  US-3 "Requirements to implementation" â†’ No matches found

Generated docs/prd-status.json with 5 stories, 0 passing.
Review and edit the file to correct mappings.
```

**Deliverables**:
- Command file: `.flight-rules/commands/prd.status-init.md`
- Heuristic matching logic

**Acceptance Criteria**:
- Parses various PRD formats
- Generates valid prd-status.json
- Provides reasonable heuristic matches
- Allows human review before committing

**Status**: ğŸ”µ Planned

---

## 4.3.7. Story Completion Metrics

**Goal**: Provide clear metrics on project completion based on story status.

**Approach**:

**Metrics Tracked**:

1. **Story-level**:
   - Total stories
   - Stories passed
   - Stories failed (attempted but not passing)
   - Stories pending (not yet attempted)
   - Pass rate percentage

2. **Task-level** (from linked tasks):
   - Total tasks across all stories
   - Tasks complete
   - Tasks verified
   - Verification rate

3. **Trend**:
   - Stories passed per day/week
   - Velocity (stories per session)
   - Time since last pass

**Dashboard Output** (via `/story-loop.status --metrics`):
```
## Project Completion Metrics

### Story Progress
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  60% (6/10)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Passed: 6  |  Failed: 1  |  Pending: 3

### Task Verification
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  70% (21/30)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Verified: 21  |  Complete (unverified): 5  |  Remaining: 4

### Velocity
  This week: 3 stories passed
  Average: 1.5 stories/day
  Projected completion: 2 days
```

**Deliverables**:
- Metrics calculation logic
- Dashboard output format

**Acceptance Criteria**:
- Metrics are accurate and current
- Progress bars are visual and clear
- Projections are reasonable

**Status**: ğŸ”µ Planned

---

## 4.3.8. Story Verification Strategies

**Goal**: Define how different types of stories are verified.

**Approach**:

**Strategy 1: Command Verification**
```json
{
  "verification": {
    "type": "command",
    "command": "npm test -- --grep 'init'",
    "expected": "exit 0"
  }
}
```
- Most reliable
- Fully automated
- Best for functional requirements

**Strategy 2: Task Completion Verification**
```json
{
  "verification": {
    "type": "tasks"
  }
}
```
- Story passes when all `implementedBy` tasks are `âœ… Complete` AND `Verified: true`
- Good for stories that are task aggregates
- Relies on task-level verification

**Strategy 3: Manual Verification**
```json
{
  "verification": {
    "type": "manual",
    "criteria": [
      "UI matches design spec",
      "Performance is acceptable",
      "Documentation is complete"
    ]
  }
}
```
- Requires human sign-off
- Loop pauses and prompts for review
- Good for subjective criteria

**Strategy 4: Composite Verification**
```json
{
  "verification": {
    "type": "composite",
    "checks": [
      { "type": "command", "command": "npm test" },
      { "type": "command", "command": "npm run build" },
      { "type": "tasks" }
    ]
  }
}
```
- Multiple checks must all pass
- Combines automated and task-based

**Deliverables**:
- Verification strategy specifications
- Examples for each type

**Acceptance Criteria**:
- All strategies are well-defined
- Clear guidance on when to use each
- Composite verification works correctly

**Status**: ğŸ”µ Planned
