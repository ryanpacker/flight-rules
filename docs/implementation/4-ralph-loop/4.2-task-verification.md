# 4.2 Task Verification Layer

This is the Phase 2 implementation â€” adding verification capabilities directly to the existing Task system in implementation specs, enabling finer-grained iteration control.

## Goals

- Add verification fields to existing Task schema
- Enable task-level iteration within sessions
- Provide `/task-loop.start` for granular control
- Maintain backward compatibility with existing specs

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TASK VERIFICATION LOOP                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. Find next unverified task (status: ğŸ”µ or ğŸŸ¡)                â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  2. Start minimal session for that task                         â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  3. Implement the task                                          â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  4. Run verification (tests, typecheck, custom command)         â”‚
â”‚                          â”‚                                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â–¼                       â–¼                           â”‚
â”‚         [PASS]                   [FAIL]                          â”‚
â”‚              â”‚                       â”‚                           â”‚
â”‚              â–¼                       â–¼                           â”‚
â”‚  5a. Mark task âœ… Complete    5b. Log failure, retry or         â”‚
â”‚      Set Verified: true           create fix task                â”‚
â”‚      Commit changes                    â”‚                         â”‚
â”‚              â”‚                       â”‚                           â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                          â–¼                                       â”‚
â”‚  6. Update progress.md with learnings                           â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  7. Loop until all tasks verified or limit reached              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Dependencies

- Phase 1: Session Continuation Mode (4.1)
- Existing Task system in `docs/implementation/`
- Implementation spec parser from existing commands

---

## 4.2.1. Extended Task Schema

**Goal**: Define verification fields that extend the existing Task format.

**Approach**:

**Current Task Format**:
```markdown
### 1.4.1. Routing Structure

**Goals:** Implement basic routing...

**Approach**: ...

**Status:** ğŸ”µ Planned
```

**Extended Task Format**:
```markdown
### 1.4.1. Routing Structure

**Goals:** Implement basic routing...

**Approach**: ...

**Status:** ğŸ”µ Planned
**Verified:** false
**Verification:**
- command: `npm test -- --grep "routing"`
- expected: exit code 0
- timeout: 60s
```

**New Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `Verified:` | `true`, `false`, or omitted | Whether the task has passed verification |
| `Verification:` | Block | Verification configuration |
| `â”œâ”€ command:` | String | Shell command to run |
| `â”œâ”€ expected:` | String | What constitutes a pass (default: "exit code 0") |
| `â”œâ”€ timeout:` | Duration | Max execution time (default: 120s) |
| `â””â”€ retries:` | Number | Retry attempts on failure (default: 0) |

**Verification Types**:

1. **Command verification** (most common):
   ```markdown
   **Verification:**
   - command: `npm test -- --grep "routing"`
   ```

2. **Build verification**:
   ```markdown
   **Verification:**
   - command: `npm run build`
   ```

3. **Type checking**:
   ```markdown
   **Verification:**
   - command: `npm run typecheck`
   ```

4. **Custom script**:
   ```markdown
   **Verification:**
   - command: `./scripts/verify-routing.sh`
   ```

5. **No verification** (explicitly manual):
   ```markdown
   **Verification:**
   - type: manual
   - criteria: "Reviewer confirms UI matches design spec"
   ```

**Backward Compatibility**:
- Tasks without `Verification:` block are treated as unverifiable
- `Verified:` field is optional; omission = not yet verified
- Existing specs remain valid

**Deliverables**:
- Extended task schema documentation
- Migration guide for adding verification to existing tasks

**Acceptance Criteria**:
- Schema is clear and parseable
- Existing tasks remain valid
- All common verification patterns are supported

**Status**: ğŸ”µ Planned

---

## 4.2.2. Task Specification Parser

**Goal**: Parse implementation spec files to extract tasks with their verification configuration.

**Approach**:

**Parser Interface**:
```typescript
interface Task {
  id: string;              // e.g., "1.4.1"
  title: string;           // e.g., "Routing Structure"
  goals: string;
  approach?: string;
  status: 'planned' | 'in_progress' | 'complete';
  verified?: boolean;
  verification?: {
    type: 'command' | 'manual';
    command?: string;
    expected?: string;
    timeout?: number;      // seconds
    retries?: number;
    criteria?: string[];   // for manual verification
  };
  sourceFile: string;      // path to spec file
  lineNumber: number;      // starting line in file
}

interface TaskGroup {
  id: string;              // e.g., "1.4"
  title: string;           // e.g., "Application Shell"
  tasks: Task[];
  sourceFile: string;
}

function parseTaskGroup(filePath: string): TaskGroup;
function parseAllTasks(implementationDir: string): Task[];
function findUnverifiedTasks(tasks: Task[]): Task[];
```

**Parsing Rules**:
1. Find H3 headers matching pattern `### N.N.N. Title`
2. Extract `**Goals:**`, `**Approach:**`, `**Status:**` fields
3. Parse optional `**Verified:**` and `**Verification:**` blocks
4. Build Task objects with source location info

**Deliverables**:
- Parser specification
- Interface definitions

**Acceptance Criteria**:
- Correctly parses extended task format
- Handles missing optional fields
- Provides source location for updates

**Status**: ğŸ”µ Planned

---

## 4.2.3. task-loop.start Command

**Goal**: Create a command that iterates through tasks with verification.

**Approach**:

Create `.flight-rules/commands/task-loop.start.md`:

```
Usage: /task-loop.start [options]

Options:
  --area <name>           Limit to specific area (e.g., "1-foundation")
  --task-group <id>       Limit to specific task group (e.g., "1.4")
  --task <id>             Start from specific task (e.g., "1.4.2")
  --max-iterations <n>    Maximum tasks to attempt (default: 10)
  --stop-on-fail          Stop loop on first verification failure
  --skip-unverifiable     Skip tasks without verification commands
  --dry-run               Show what would be executed without running
```

**Command Flow**:

1. **Discover tasks**
   - Scan `docs/implementation/` for task specs
   - Filter by area/task-group if specified
   - Find tasks with status ğŸ”µ Planned or ğŸŸ¡ In Progress
   - Filter to those with verification commands (if `--skip-unverifiable`)

2. **Initialize loop state**
   - Create/update `docs/.task-loop-state.json`:
     ```json
     {
       "status": "running",
       "startedAt": "2025-01-17T14:00:00Z",
       "maxIterations": 10,
       "currentIteration": 1,
       "currentTask": "1.4.1",
       "completedTasks": [],
       "failedTasks": [],
       "scope": {
         "area": "1-foundation",
         "taskGroup": null
       }
     }
     ```

3. **Execute task**
   - Read task details from spec
   - Implement the task (AI does the work)
   - Run verification command
   - Capture results

4. **Update task status**
   - On pass: Set `Status: âœ… Complete`, `Verified: true`
   - On fail: Log failure, optionally retry, create fix note

5. **Continue or terminate**
   - More tasks and under limit â†’ next task
   - All done or limit reached â†’ generate summary

**Deliverables**:
- Command file: `.flight-rules/commands/task-loop.start.md`
- State file schema: `docs/.task-loop-state.json`

**Acceptance Criteria**:
- Correctly scans and filters tasks
- Executes verification commands
- Updates spec files with new status
- Respects iteration limits
- Produces clear progress output

**Status**: ğŸ”µ Planned

---

## 4.2.4. task-loop.status Command

**Goal**: Display the current state of an ongoing task loop.

**Approach**:

Create `.flight-rules/commands/task-loop.status.md`:

**Output Format**:
```
## Task Loop Status

Currently: RUNNING (iteration 3/10)
Scope: Area 1-foundation, all task groups
Current task: 1.4.2 Left Sidebar Implementation

Progress:
  âœ… 1.4.1 Routing Structure (verified in 2m 34s)
  âœ… 1.4.3 Header Component (verified in 1m 12s)
  ğŸŸ¡ 1.4.2 Left Sidebar Implementation (in progress)
  ğŸ”µ 1.4.4 Footer Component (pending)
  ğŸ”µ 1.4.5 Layout Integration (pending)

Failures: 0
Elapsed: 8m 22s
```

**Deliverables**:
- Command file: `.flight-rules/commands/task-loop.status.md`

**Acceptance Criteria**:
- Shows accurate current state
- Displays tasks in logical order
- Indicates verification status
- Shows failures with context

**Status**: ğŸ”µ Planned

---

## 4.2.5. task-loop.stop Command

**Goal**: Allow graceful termination of a running task loop.

**Approach**:

Create `.flight-rules/commands/task-loop.stop.md`:

**Behavior**:
- Set state to "stopping"
- Complete current task
- Generate summary
- Preserve remaining tasks in queue

**Deliverables**:
- Command file: `.flight-rules/commands/task-loop.stop.md`

**Acceptance Criteria**:
- Gracefully stops after current task
- Does not interrupt work in progress
- Generates completion summary

**Status**: ğŸ”µ Planned

---

## 4.2.6. Task Status Updater

**Goal**: Automatically update task status and verified fields in spec files.

**Approach**:

After task completion/verification:

1. **Read spec file** containing the task
2. **Locate task section** by ID (e.g., "### 1.4.1.")
3. **Update fields**:
   - Replace `**Status:** ğŸ”µ Planned` with `**Status:** âœ… Complete`
   - Add or update `**Verified:** true`
   - If failed: Update status to `ğŸŸ¡ In Progress`, add failure note

**Update Logic**:
```typescript
function updateTaskStatus(
  specFile: string,
  taskId: string,
  newStatus: 'planned' | 'in_progress' | 'complete',
  verified?: boolean,
  notes?: string
): void;
```

**Example Transformation**:

Before:
```markdown
**Status:** ğŸ”µ Planned
```

After (success):
```markdown
**Status:** âœ… Complete
**Verified:** true (2025-01-17, npm test)
```

After (failure):
```markdown
**Status:** ğŸŸ¡ In Progress
**Verified:** false
**Last Attempt:** 2025-01-17 - Failed: npm test exit code 1
```

**Deliverables**:
- Status update specification
- File modification logic

**Acceptance Criteria**:
- Correctly modifies spec files in place
- Preserves other content
- Handles missing fields gracefully
- Logs all modifications

**Status**: ğŸ”µ Planned

---

## 4.2.7. Verification Failure Handling

**Goal**: Define strategies for handling verification failures at the task level.

**Approach**:

**Failure Modes**:

1. **Retry** (if configured):
   - Re-attempt implementation
   - Run verification again
   - Up to N retries (from task config or command option)

2. **Create Fix Task**:
   - Add a new task to the task group:
     ```markdown
     ### 1.4.1a. Fix: Routing Structure Verification

     **Goals:** Fix verification failure for 1.4.1

     **Context:**
     - Original task: 1.4.1 Routing Structure
     - Verification command: `npm test -- --grep "routing"`
     - Failure: Exit code 1
     - Error output: [captured stderr]

     **Status:** ğŸ”µ Planned
     **Verification:**
     - command: `npm test -- --grep "routing"`
     ```

3. **Pause for Human**:
   - Stop the loop
   - Log detailed failure info
   - Wait for human intervention

4. **Skip and Continue**:
   - Log the failure
   - Move to next task
   - Include in summary

**Configuration**:
- Per-task: In the `Verification:` block
- Global: Via command options (`--stop-on-fail`, etc.)

**Deliverables**:
- Failure handling specification
- Fix task template

**Acceptance Criteria**:
- All failure modes implemented
- Clear logging of failures
- Fix tasks are actionable

**Status**: ğŸ”µ Planned

---

## 4.2.8. Integration with Session Continuation

**Goal**: Enable task-loop to work within continuous sessions.

**Approach**:

Two integration modes:

**Mode 1: Task Loop within Session**
- A single continuous session can execute multiple tasks
- Session's "Next Steps" can reference task IDs:
  ```markdown
  ## Next Steps

  1. **[VERIFY: task-loop]** Complete remaining tasks in 1.4 Application Shell
     - Tasks: 1.4.2, 1.4.3, 1.4.4
  ```
- When session encounters this, it runs task-loop internally

**Mode 2: Task Loop as Session Unit**
- Each task is a separate session
- Continuous session loop spawns one session per task
- More overhead but better isolation

**Configuration**:
- Default: Mode 1 (multiple tasks per session)
- Option: `--session-per-task` for Mode 2

**Deliverables**:
- Integration specification
- Modified continuous-session handling for task references

**Acceptance Criteria**:
- Both modes work correctly
- Proper state coordination between loops
- Clear documentation of tradeoffs

**Status**: ğŸ”µ Planned
