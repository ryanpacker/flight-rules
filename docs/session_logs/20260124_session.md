# Session Log: 2026-01-24

## Session Goals

1. **Add `flight-rules ralph` CLI command** — Implement an autonomous "Ralph Loop" that spawns fresh Claude Code instances repeatedly until all task groups in implementation specs are complete
2. **Create the ralph-loop.md prompt** — The prompt file that gets fed to each Claude iteration
3. **Write tests and documentation** — Ensure the feature is well-tested and documented

## Related Specs

- This is a new feature that will require a new implementation spec
- Proposed: Task Group `2.6-ralph-command.md` under CLI Core

## Technical Approach

### Overview

The Ralph Loop is a bash-style loop wrapped in a CLI command. Each iteration:
1. Spawns a fresh Claude Code instance with `--dangerously-skip-permissions -p`
2. Feeds it the `ralph-loop.md` prompt via stdin
3. Claude finds the next incomplete task group and implements it
4. Claude outputs `<ralph-signal>COMPLETE</ralph-signal>` when all tasks are done
5. The CLI detects this signal and exits, or continues to the next iteration

### Key Design Decisions

1. **Signal format**: `<ralph-signal>COMPLETE</ralph-signal>` (clearer than `<promise>COMPLETE</promise>`)

2. **Quality check discovery**: The prompt will instruct Claude to read `package.json` scripts rather than assuming specific commands exist

3. **Ralph-specific logging**: Create verbose logs at `docs/ralph_logs/YYYYMMDD_HHMM_ralph.md` separate from regular session logs

4. **Error handling**: Follow existing CLI patterns - return early for expected failures, throw for unexpected errors

5. **No init/upgrade changes needed**: The `payload/prompts/` directory is already included in the framework copy logic

### Files to Create

| File | Purpose |
|------|---------|
| `src/commands/ralph.ts` | CLI command implementation |
| `payload/prompts/ralph-loop.md` | Prompt for autonomous agent |
| `tests/commands/ralph.test.ts` | Unit tests |

### Files to Modify

| File | Change |
|------|--------|
| `src/index.ts` | Add ralph command case and help text |
| `README.md` | Document the ralph feature |
| `docs/implementation/2-cli-core/index.md` | Add reference to new task group (if exists) |

## Task Breakdown

### Task 1: Create the ralph-loop.md prompt

Create `payload/prompts/ralph-loop.md` with:
- Instructions for finding the next incomplete task group
- Task implementation workflow
- Quality check discovery (read package.json)
- Ralph-specific logging format
- The `<ralph-signal>COMPLETE</ralph-signal>` output convention
- Rules for autonomous operation

### Task 2: Create src/commands/ralph.ts

Implement the command with:
- Options parsing: `--max-iterations`, `--dry-run`, `--verbose`
- Validation: Flight Rules installed, prompt file exists, Claude CLI available
- Loop logic: spawn Claude, capture output, detect completion signal
- Progress reporting with @clack/prompts

Follow patterns from `update.ts` for spawning child processes.

### Task 3: Wire into src/index.ts

- Import the ralph command
- Add case in the switch statement
- Add to help text

### Task 4: Write tests

Create `tests/commands/ralph.test.ts` with:
- Test for "Flight Rules not installed" error
- Test for "prompt file missing" error
- Test for dry-run mode (no spawn)
- Test for completion signal detection
- Test for max iterations limit

### Task 5: Update documentation

- Add "Autonomous Development with Ralph" section to README.md
- Include usage examples, prerequisites, and best practices

## Alternatives Considered

1. **Bash script instead of CLI command**: Simpler, but loses the benefit of Flight Rules CLI integration, validation, and consistent UX

2. **Store state between iterations**: Rejected - the whole point of Ralph is fresh context each iteration, with persistence via git/docs

3. **Use allowedTools config instead of --dangerously-skip-permissions**: More granular but harder to configure correctly for autonomous operation

## Constraints

1. **Claude Code must be installed**: The command will error if `claude` CLI is not available

2. **Requires --dangerously-skip-permissions**: This flag is intended for container/automation use - users should understand the security implications

3. **Quality checks must be configured**: If a project doesn't have `npm test` or similar, quality checks will be skipped or fail

## Potential Challenges

1. **Claude CLI interface changes**: The `--dangerously-skip-permissions -p` flags are current as of 2026, but could change

2. **Output parsing**: Need to reliably detect the completion signal in Claude's output, which may include other content

3. **Error recovery**: If Claude crashes mid-task, the loop continues but the task may be left incomplete

## Acceptance Criteria

- [x] `flight-rules ralph` runs the loop correctly
- [x] `flight-rules ralph --max-iterations 5` limits iterations
- [x] `flight-rules ralph --dry-run` shows info without executing
- [x] `flight-rules ralph --verbose` shows Claude output
- [x] `flight-rules ralph --area 2` targets specific implementation area
- [x] `flight-rules ralph --branch` creates new branch (auto-generates name)
- [x] `flight-rules ralph --branch name` creates branch with custom name
- [x] Branch creation validates clean git state
- [x] Loop stops when `<ralph-signal>COMPLETE</ralph-signal>` is detected
- [x] Loop stops after max iterations with appropriate message
- [x] Appropriate error messages for missing dependencies
- [x] Tests pass (186 total, 16 for ralph)
- [x] README documents all features and best practices

## Summary

Successfully implemented the `flight-rules ralph` command - an autonomous agent loop that spawns fresh Claude Code instances to work through implementation task groups unattended.

## Code Areas Touched

- `payload/prompts/ralph-loop.md` — New prompt file for autonomous agent
- `src/commands/ralph.ts` — CLI command with --area and --branch support, git operations
- `src/index.ts` — Added ralph command, parseIntArg, parseStringArg, parseBranchArg helpers
- `tests/commands/ralph.test.ts` — 16 tests (validation, dry-run, area, branch, completion)
- `README.md` — Added "Autonomous Development with Ralph" section with all options

## Key Decisions

- Used `<ralph-signal>COMPLETE</ralph-signal>` instead of `<promise>COMPLETE</promise>` for clearer semantics
- Ralph-specific logging goes to `docs/ralph_logs/` for verbose autonomous session documentation
- Quality checks are discovered by reading `package.json` rather than hardcoding commands
- Followed existing CLI patterns: return early for expected failures, spawn patterns from update.ts

## Challenges & Solutions

- **3-attempt tracking clarification**: Originally the spec said "if stuck after 3 attempts" which seemed to imply cross-iteration state. Clarified that this refers to retry attempts within a single iteration, which makes sense since each iteration is a fresh Claude instance.

## Next Steps

- Test the command on a real project with incomplete task groups
- Consider adding a `--continue` flag to resume from a specific task group
- Consider adding support for `allowedTools` configuration as an alternative to `--dangerously-skip-permissions`

## Learnings

- The `payload/prompts/` directory was already included in the framework copy logic (`copyFrameworkFilesFrom`), so no changes to init/upgrade were needed
- The existing CLI patterns (update.ts especially) provide good templates for spawning child processes
