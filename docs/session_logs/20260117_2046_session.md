# Session Log: 2026-01-17 20:46

## Session Goals

- Implement the `version.bump` command (Task 3.7.1)
- Support both one-shot mode (`version.bump patch`) and conversational mode
- Create a prompt-based workflow that analyzes commits and recommends semver bumps

## Related Specs

- Task Group: `3.7-release-commands.md`
- Tasks: 3.7.1

## Technical Approach

### Command Structure

Create `payload/commands/version.bump.md` as a prompt-based workflow that instructs agents to:

1. **Determine mode** based on whether user provided an argument
2. **Find the most recent version tag** in git history
3. **Analyze commits** since that tag
4. **Recommend or apply** the version bump

### One-Shot Mode

When user provides `version.bump {major|minor|patch}`:
1. Validate the argument
2. Detect project type
3. Apply the bump directly using appropriate tooling
4. Report the result

### Conversational Mode

When user provides just `version.bump`:
1. Find latest version tag using `git tag --sort=-v:refname | head -1` or `git describe --tags --abbrev=0`
2. Get commits since tag: `git log {tag}..HEAD --oneline`
3. Analyze commit messages for:
   - **Breaking changes** (BREAKING CHANGE, !, major API changes) â†’ major
   - **New features** (feat:, feature, "add", "new") â†’ minor
   - **Bug fixes, docs, refactoring** (fix:, docs:, refactor:, chore:) â†’ patch
4. Present summary of changes grouped by type
5. Recommend bump level with clear reasoning
6. Ask user to confirm or override
7. Apply the bump

### Project Type Detection

Check for project files in order:
- `package.json` â†’ npm project â†’ use `npm version {level}`
- `pyproject.toml` or `setup.py` â†’ Python project â†’ update version string
- `Cargo.toml` â†’ Rust project â†’ update version string
- Fallback: Look for common version patterns in files

For this session, focus on npm projects since Flight Rules itself is npm-based.

### npm Version Integration

For npm projects, `npm version {patch|minor|major}`:
- Updates `package.json` version
- Runs the `version` lifecycle script (which in Flight Rules runs `sync-version.js`)
- Creates a git commit with message matching the version
- Creates a git tag

The command should inform the agent of this behavior so it doesn't duplicate steps.

## Alternatives Considered

1. **Executable CLI command vs prompt-based** â€” Chose prompt-based to align with Flight Rules' design philosophy (agents interpret and execute)
2. **Conventional Commits strict parsing vs heuristic** â€” Chose heuristic approach since not all projects follow Conventional Commits strictly
3. **Handle all project types now vs npm first** â€” Chose npm first, document others for future expansion

## Constraints

- Must handle both `v1.0.0` and `1.0.0` tag formats
- Must gracefully handle projects with no version tags
- Should not duplicate what `npm version` already does
- Should leverage existing `scripts/sync-version.js` when present

## Potential Challenges

1. **No version tags exist** â€” Provide helpful message and ask user to create initial tag or specify starting version
2. **Ambiguous commit messages** â€” When in doubt, recommend patch and explain reasoning
3. **Uncommitted changes** â€” `npm version` fails with uncommitted changes; command should detect and warn

## Task Breakdown

1. Create `payload/commands/version.bump.md` with:
   - Mode detection (one-shot vs conversational)
   - Git tag detection logic
   - Commit analysis instructions
   - Recommendation presentation format
   - npm version execution steps
   - Edge case handling

2. Update `docs/implementation/3-workflow-commands/3.7-release-commands.md`:
   - Mark task 3.7.1 as ðŸŸ¡ In Progress â†’ âœ… Complete

## Code Areas Touched

- `payload/commands/version.bump.md` (new)
- `docs/implementation/3-workflow-commands/3.7-release-commands.md` (status update)

## Summary

Created the `version.bump` command as a prompt-based workflow for AI agents. The command supports:

- **One-shot mode**: `version.bump {major|minor|patch}` applies the specified bump directly
- **Conversational mode**: Analyzes commits since the last version tag and recommends a bump level

Key features:
- Detects project type (npm, Python, Rust, Go)
- Finds latest version tag in git history
- Categorizes commits as breaking changes, features, or fixes
- Recommends semver bump with clear reasoning
- Uses native tooling (`npm version`, `poetry version`) where available
- Handles edge cases (no tags, uncommitted changes)

## Key Decisions

- **npm version integration**: For npm projects, the command instructs agents to use `npm version` directly, which handles the commit, tag, and runs lifecycle scripts (like `sync-version.js`)
- **Heuristic commit analysis**: Rather than strict Conventional Commits parsing, uses heuristics to catch various commit message styles
- **Default to patch**: When commit analysis is ambiguous, recommends patch as the safest option

## Next Steps

- Test the command in a real scenario
- Consider adding the command to the Claude Code adapter (`.claude/commands/`)
- Implement `project.release` command (Task 3.7.2) when ready
