# Session Log: 2026-01-17

## Session Goals

- Implement complete update command feature (all 4 tasks in 2.5)
- Add passive version check notification to all CLI commands
- Support release channel awareness (dev vs latest)
- Write tests for new functionality

## Related Specs

- Task Group: `2.5-update-command.md`
- Tasks: 2.5.1, 2.5.2, 2.5.3, 2.5.4

## Technical Approach

### 2.5.1 User-Level Config

**New file:** `src/utils/config.ts`

```typescript
interface UserConfig {
  channel: 'dev' | 'latest';
  lastUpdateCheck?: {
    timestamp: string;      // ISO date string
    latestVersion: string;  // version on configured channel
  };
}
```

**Functions:**
- `getConfigPath()` → `~/.flight-rules/config.json`
- `readConfig()` → returns UserConfig (creates default if missing)
- `writeConfig(config)` → persists to disk
- `getChannel()` → shorthand for reading channel
- `setChannel(channel)` → shorthand for updating channel

**Default config:** `{ channel: 'dev' }`

### 2.5.2 Version Check Logic

**New file:** `src/utils/version-check.ts`

**Functions:**
- `checkForUpdate(options?)` → `{ currentVersion, latestVersion, updateAvailable }`
  - Options: `{ force?: boolean }` to bypass cache
  - Fetches `https://registry.npmjs.org/flight-rules`
  - Reads `dist-tags.dev` or `dist-tags.latest` based on channel
  - Compares against installed CLI version
  - Caches result in config (timestamp + version)
  - Returns cached result if within 24 hours (unless forced)
  - Silent failure on network errors (returns null)

**Cache logic:**
- Store `lastUpdateCheck.timestamp` and `lastUpdateCheck.latestVersion`
- Check is stale if timestamp > 24 hours ago
- Force flag bypasses cache entirely

### 2.5.3 Passive Update Notification

**Modify:** `src/index.ts`

**Approach:**
- After command completes, call `showUpdateNotificationIfNeeded()`
- Only runs if:
  - `isInteractive()` is true (TTY mode)
  - `FLIGHT_RULES_NO_UPDATE_CHECK` env var is not set
- Uses cached check (doesn't slow down commands)
- Message format: `Update available: 0.5.9 → 0.6.0. Run 'flight-rules update' to upgrade.`

**Placement:** After the switch statement completes, before any final outro

### 2.5.4 Update Command

**New file:** `src/commands/update.ts`

**CLI interface:**
- `flight-rules update` — check and update within current channel
- `flight-rules update --channel=dev` — switch to dev channel
- `flight-rules update --channel=latest` — switch to latest channel

**Flow (interactive):**
1. Parse `--channel` flag if present
2. Force version check (bypass cache)
3. Display current version and latest version
4. If no update available: "You're on the latest version"
5. If update available: confirm "Update from X to Y?"
6. On confirm: run `npm install -g flight-rules@{channel}`
7. Update channel in config if `--channel` was specified

**Flow (non-interactive):**
1. Force version check
2. Display version info
3. If update available: "Run interactively to update"
4. Do NOT perform update (safe default)

**npm execution:**
- Use `child_process.spawn` or `execSync`
- Capture and display output
- Handle errors gracefully

## Alternatives Considered

1. **Separate `check-update` and `update` commands** — Decided single `update` command is simpler; force flag handles explicit checks
2. **Store config per-project vs user-level** — User-level chosen so one check per day across all projects
3. **Update via download vs npm** — npm is simpler and handles permissions consistently

## Constraints

- Must not slow down normal CLI operations (async/cached checks)
- Must work in both TTY and non-TTY environments
- Default channel is `dev` during pre-1.0
- Network failures must be silent (don't break CLI)

## Potential Challenges

1. **npm global install permissions** — Some users use sudo, others don't. Solution: Let npm handle it; if it fails, show the error
2. **Cross-platform home directory** — Use `os.homedir()` for consistency
3. **Race conditions on config file** — Low risk for CLI tool; simple read/write is sufficient

## Task Breakdown

1. Create `src/utils/config.ts` with config read/write utilities
2. Create `src/utils/version-check.ts` with npm registry fetch and caching
3. Create `src/commands/update.ts` with the update command
4. Modify `src/index.ts` to:
   - Add `update` case to switch statement
   - Add passive notification after commands
   - Update help text
5. Create `tests/utils/config.test.ts`
6. Create `tests/utils/version-check.test.ts`
7. Create `tests/commands/update.test.ts`
8. Update spec file statuses to ✅ Complete

## Code Areas Touched

- `src/utils/config.ts` (new) — User-level config read/write
- `src/utils/version-check.ts` (new) — npm registry check with caching
- `src/commands/update.ts` (new) — Update command with channel support
- `src/index.ts` (modified) — Added update command routing and passive notification
- `tests/utils/config.test.ts` (new) — 16 tests
- `tests/utils/version-check.test.ts` (new) — 12 tests
- `tests/commands/update.test.ts` (new) — 12 tests
- `docs/implementation/2-cli-core/2.5-update-command.md` (status updates)

## Summary

Implemented complete update command feature for Flight Rules CLI:

- Created user-level config system at `~/.flight-rules/config.json` for storing release channel preference and update check cache
- Implemented version check logic that fetches from npm registry with 24-hour caching
- Added passive update notification that displays after any CLI command (in TTY mode)
- Created `flight-rules update` command with `--channel` flag support
- Added 40 new tests (170 total, all passing)

## Key Decisions

- **User-level config vs project-level**: Chose user-level (`~/.flight-rules/config.json`) so update checks are cached once per day across all projects
- **Passive notification placement**: Shows after command completes, not before, to avoid delaying the user's intended action
- **Non-interactive behavior**: Shows info only, doesn't perform updates (safe default)
- **spawn vs execSync**: Used spawn for npm install to capture output streams and handle errors gracefully

## Challenges & Solutions

- **Mocking spawn in tests**: The async nature of spawn's event-based callbacks made reliable testing difficult. Simplified tests to focus on what could be reliably verified without complex async mocking.
- **Vitest module mocking**: Required `vi.doMock` with `vi.resetModules` pattern for dynamic imports to properly isolate test cases.

## Learnings

- `vi.stubGlobal('fetch', mockFn)` is the reliable way to mock global fetch in Vitest
- For complex async operations like spawn, it's sometimes better to have fewer but more reliable tests than comprehensive but flaky ones
- The npm registry provides dist-tags at `https://registry.npmjs.org/{package}` which includes `dev` and `latest` tags

## Next Steps

- Publish new CLI version to npm
- Test update command end-to-end in a real environment
- Consider adding `--force` flag to bypass confirmation in interactive mode
